<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Term Sheet VC - EV & Probabilities</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .slider-thumb::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
            margin-left: 4px;
            color: #9ca3af;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 50;
            bottom: 150%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: all 0.2s ease-in-out;
            font-size: 11px;
            line-height: 1.4;
            font-weight: normal;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            bottom: 125%;
        }

        @media (max-width: 640px) {
            .tooltip .tooltiptext {
                width: 180px;
                left: auto;
                right: -20px;
                transform: none;
            }

            .tooltip .tooltiptext::after {
                left: auto;
                right: 25px;
            }
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center md:text-left flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Kalkulator Founder'a PRO</h1>
                <p class="text-gray-600 mt-2">Equity + Podatki + Ryzyko (EV)</p>
            </div>
            <div class="flex flex-wrap justify-center md:justify-end items-center gap-2 mt-4 md:mt-0">
                <button onclick="exportData('csv')"
                    class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    CSV
                </button>
                <button onclick="exportData('xlsx')"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    XLSX
                </button>
                <div
                    class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg text-sm font-semibold border border-indigo-200">
                    v3.2: Export
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- Lewa Kolumna: Parametry wejściowe (4 cols) -->
            <div class="lg:col-span-4 space-y-6">

                <!-- Sekcja 1: Twoja Pozycja -->
                <div class="card p-5 border-l-4 border-blue-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-3">1. Ty i Twoja Pensja</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500">
                                    Obecne udziały (Pre)
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Twój procentowy udział w kapitale spółki przed
                                            wejściem obecnego inwestora lub przed nową rundą.</span>
                                    </span>
                                </label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="userSharesPre" value="50"
                                        class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500"
                                        oninput="calculate()">
                                    <span class="ml-1 text-gray-500 text-sm">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">
                                    Rocznie (Faktura/Brutto)
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Całkowity koszt pracodawcy (UoP) lub kwota netto na
                                            fakturze (B2B). To Twoja "pewna" kasa.</span>
                                    </span>
                                </label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="salary" value="360000"
                                        class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500"
                                        oninput="calculate()">
                                    <span class="ml-1 text-gray-500 text-sm">PLN</span>
                                </div>
                            </div>
                        </div>

                        <!-- Contract Type Selector -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Forma współpracy</label>
                            <select id="contractType"
                                class="w-full p-2 border rounded text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500"
                                onchange="calculate()">
                                <option value="b2b_lin">B2B - Podatek Liniowy (19%)</option>
                                <option value="b2b_ryczalt">B2B - Ryczałt (12% IT/Mgmt)</option>
                                <option value="uop">Umowa o Pracę (Skala 12/32%)</option>
                            </select>
                            <p class="text-[10px] text-gray-400 mt-1" id="taxDesc">ZUS, składka zdrowotna i PIT 19%.</p>
                        </div>
                        <div id="salaryWarning"
                            class="hidden mt-2 p-3 bg-red-50 text-red-700 text-[11px] rounded-lg border border-red-100 flex items-start gap-2">
                            <span class="text-base">⚠️</span>
                            <div>
                                <p class="font-bold">Generujesz dług!</p>
                                <p>Pensja nie pokrywa kosztów stałych (ZUS, składka zdrowotna). Musisz dopłacać do
                                    biznesu.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sekcja 2: Warunki Inwestora -->
                <div class="card p-5 border-l-4 border-purple-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-3">2. Inwestor & Term Sheet</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500">
                                    Inwestycja
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Kwota gotówki, którą inwestor wpłaca do spółki w
                                            zamian za nowe udziały.</span>
                                    </span>
                                </label>
                                <input type="number" id="invAmount" value="8000000"
                                    class="w-full p-2 border rounded text-sm mt-1" oninput="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">
                                    Udziały (Post)
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Procent akcji, który Inwestor obejmuje w spółce PO
                                            wpłaceniu pieniędzy (Post-money).</span>
                                    </span>
                                </label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="invPercent" value="20"
                                        class="w-full p-2 border rounded text-sm" oninput="calculate()">
                                    <span class="ml-1 text-gray-500 text-sm">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Liquidation Preference -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-medium text-gray-700">
                                    Liq. Preference
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Gwarancja dla inwestora, że przy wyjściu odzyska
                                            X-krotność inwestycji przed wypłatą dla Ciebie. 1x to standard
                                            rynkowy.</span>
                                    </span>
                                </label>
                                <span class="text-sm font-bold text-blue-600" id="liqPrefVal">1.5x</span>
                            </div>
                            <input type="range" id="liqPref" min="1" max="3" step="0.25" value="1.5"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                oninput="document.getElementById('liqPrefVal').innerText = this.value + 'x'; calculate()">
                        </div>

                        <!-- Participating Switch -->
                        <div class="flex items-center justify-between bg-red-50 p-3 rounded-lg border border-red-100">
                            <div>
                                <label class="block text-sm font-bold text-red-700">
                                    Participating?
                                    <span class="tooltip">
                                        <svg class="w-3 h-3 text-red-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">"Double dipping". Inwestor najpierw bierze swoją
                                            preferencję (np. 1x), a potem DODATKOWO dzieli się resztą puli
                                            proporcjonalnie do udziałów. Bardzo niekorzystne dla foundera.</span>
                                    </span>
                                </label>
                                <p class="text-[10px] text-red-500 leading-tight">Double dipping: kasa + procent.</p>
                            </div>
                            <div
                                class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="isParticipating"
                                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"
                                    onclick="calculate()" />
                                <label for="toggle"
                                    class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700">
                                    Dywidenda %
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Roczna skumulowana dywidenda (accrued dividend).
                                            Zwiększa Preface Stack inwestora o % rocznie od wkładu.</span>
                                    </span>
                                </label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="dividendRate" value="0"
                                        class="w-full p-2 border rounded text-sm" placeholder="0" oninput="calculate()">
                                    <span class="ml-1 text-gray-500 text-sm">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700">
                                    ESOP (Founder)
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Pula udziałów dla pracowników (Option Pool), która
                                            powstaje podczas rundy i rozwadnia założycieli (tzw. Option Pool
                                            Shuffle).</span>
                                    </span>
                                </label>
                                <div class="flex items-center mt-1">
                                    <input type="number" id="esopPercent" value="0"
                                        class="w-full p-2 border rounded text-sm" oninput="calculate()">
                                    <span class="ml-1 text-gray-500 text-sm">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sekcja 3: Exit & Prawdopodobieństwo -->
                <div class="card p-5 border-l-4 border-green-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-3">3. Wyjście i Prawdopodobieństwo</h2>
                    <div class="space-y-4">
                        <!-- Valuation -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700">
                                Wycena Exit (Post-Money)
                                <span class="tooltip">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="tooltiptext">Twoja hipoteza: za ile sprzedasz spółkę. To od tej kwoty
                                        liczony jest cały waterfall wypłat.</span>
                                </span>
                            </label>
                            <input type="range" id="exitValSlider" min="5000000" max="150000000" step="1000000"
                                value="50000000" class="w-full mt-2" oninput="syncExitVal(this.value)">
                            <div class="flex items-center mt-1">
                                <input type="number" id="exitValInput" value="50000000"
                                    class="w-full p-2 border rounded text-sm font-bold text-green-700"
                                    oninput="syncExitVal(this.value)">
                                <span class="ml-1 text-gray-500 text-sm">PLN</span>
                            </div>
                        </div>

                        <!-- Probability Slider -->
                        <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-bold text-yellow-800">
                                    Szansa na taki Exit
                                    <span class="tooltip">
                                        <svg class="w-3 h-3 text-yellow-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Realistyczne prawdopodobieństwo, że spółka zostanie
                                            sprzedana za taką kwotę. Startup to ryzyko - większość kończy na 0.</span>
                                    </span>
                                </label>
                                <span class="text-sm font-bold text-yellow-700" id="probVal">20%</span>
                            </div>
                            <input type="range" id="exitProb" min="1" max="100" step="1" value="20"
                                class="w-full h-2 bg-yellow-200 rounded-lg appearance-none cursor-pointer"
                                oninput="document.getElementById('probVal').innerText = this.value + '%'; calculate()">
                            <p class="text-[10px] text-yellow-600 mt-1">Wpływa na obliczenie EV (Wartości Oczekiwanej).
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-700">Miesiąc wyjścia</label>
                                <input type="number" id="monthsExit" value="48"
                                    class="w-full p-2 border rounded text-sm" oninput="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700">
                                    Podatek Equity
                                    <span class="tooltip">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Podatek od zysków kapitałowych (np. Belka 19%).
                                            Płacisz go tylko od realnego zysku przy sprzedaży udziałów.</span>
                                    </span>
                                </label>
                                <div class="flex items-center">
                                    <input type="number" id="taxRate" value="19"
                                        class="w-full p-2 border rounded text-sm" oninput="calculate()">
                                    <span class="ml-1 text-gray-500 text-sm">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prawa Kolumna: Wyniki (8 cols) -->
            <div class="lg:col-span-8 space-y-6">

                <!-- Top Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="card p-4 text-center">
                        <p class="text-xs text-gray-500 uppercase font-bold">Twoje Udziały</p>
                        <p class="text-xl font-black text-blue-600" id="userDilutedShares">-</p>
                        <p class="text-[10px] text-gray-400" id="dilutionInfo">Rozwodnienie</p>
                    </div>
                    <div class="card p-4 text-center border border-green-200 bg-green-50">
                        <p class="text-xs text-green-600 uppercase font-bold">TOTAL DO RĘKI</p>
                        <p class="text-xl font-black text-green-600" id="userNetTotal">-</p>
                        <p class="text-[10px] text-green-500">Equity Net + Pensja Net</p>
                    </div>
                    <!-- New EV Card -->
                    <div class="card p-4 text-center border border-purple-200 bg-purple-50 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-purple-200 text-purple-800 text-[10px] px-2 font-bold">
                            REALITY CHECK</div>
                        <p class="text-xs text-purple-700 uppercase font-bold mt-1">
                            Total EV (Ważone)
                            <span class="tooltip">
                                <svg class="w-3 h-3 inline pb-0.5" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="tooltiptext">Expected Value. Statystyczna wartość Twojej obecnej pozycji.
                                    Mnożymy potencjalny zysk przez szansę sukcesu. Jeśli EV < Pensja na etacie, to
                                        biznesowo "nie opłaca się" ryzykować.</span>
                                </span>
                        </p>
                        <p class="text-xl font-black text-purple-700" id="evTotal">-</p>
                        <p class="text-[10px] text-purple-500">Wartość Oczekiwana</p>
                    </div>
                    <div class="card p-4 text-center bg-gray-50">
                        <p class="text-xs text-gray-500 uppercase font-bold" id="salaryLabelDisplay">Pensja Netto</p>
                        <p class="text-xl font-black text-gray-800" id="salaryNetTotalDisplay">-</p>
                        <p class="text-[10px] text-gray-400">Pewna kasa (Risk Free)</p>
                    </div>
                </div>

                <!-- Waterfall Chart -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Podział Kwoty Wyjścia (Waterfall)</h3>
                        <div id="participatingBadge"
                            class="hidden bg-red-100 text-red-800 text-xs px-2 py-1 rounded font-bold uppercase">
                            Participating Active</div>
                    </div>
                    <div class="relative h-72 w-full">
                        <canvas id="waterfallChart"></canvas>
                    </div>
                </div>

                <!-- Comparison Table -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Equity Calculation -->
                    <div class="card p-0 overflow-hidden">
                        <div class="bg-gray-100 px-4 py-3 border-b">
                            <h3 class="text-sm font-bold text-gray-700">Rozliczenie Equity (Wyjście)</h3>
                        </div>
                        <div class="p-4 space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Kwota Wyjścia</span>
                                <span class="font-bold" id="tblExit">-</span>
                            </div>
                            <div class="flex justify-between text-red-600">
                                <span>
                                    - Preference Stack
                                    <span class="tooltip">
                                        <svg class="w-3 h-3 inline pb-0.5" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="tooltiptext">Kwota należna inwestorowi przed jakimkolwiek podziałem
                                            dla założycieli. Obejmuje wkład * mnożnik oraz skumulowane dywidendy.</span>
                                    </span>
                                </span>
                                <span class="font-bold" id="tblPref">-</span>
                            </div>
                            <div class="flex justify-between border-t pt-2">
                                <span class="text-gray-800 font-medium">Common Pool</span>
                                <span class="font-bold text-gray-800" id="tblCommon">-</span>
                            </div>
                            <div class="flex justify-between text-blue-600">
                                <span>Twój udział</span>
                                <span class="font-bold" id="tblUserGross">-</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>Podatek (<span id="taxRateDisplay">19</span>%)</span>
                                <span id="tblTax">-</span>
                            </div>
                            <div class="flex justify-between font-bold text-green-600 text-lg border-t pt-2">
                                <span>Equity Netto</span>
                                <span id="tblUserNet">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Reality Check & EV -->
                    <div class="card p-0 overflow-hidden">
                        <div class="bg-purple-100 px-4 py-3 border-b border-purple-200">
                            <h3 class="text-sm font-bold text-purple-900">EV: Reality Check</h3>
                        </div>
                        <div class="p-4 space-y-4 text-sm">
                            <div class="bg-white p-3 rounded border border-purple-100">
                                <p class="text-xs text-gray-500 mb-1">Matematyczna wartość Twojej decyzji:</p>
                                <div class="flex justify-between items-center mb-2">
                                    <span>Szansa sukcesu:</span>
                                    <span class="font-bold text-yellow-600" id="evProbDisplay">-</span>
                                </div>
                                <div class="flex justify-between items-center text-gray-400 text-xs">
                                    <span>Equity EV:</span>
                                    <span id="evEquity">-</span>
                                </div>
                                <div class="flex justify-between items-center text-gray-400 text-xs border-b pb-2 mb-2">
                                    <span>Salary (Guaranteed):</span>
                                    <span id="evSalary">-</span>
                                </div>
                                <div class="flex justify-between items-center font-bold text-purple-700 text-lg">
                                    <span>TOTAL EV:</span>
                                    <span id="evTotalBox">-</span>
                                </div>
                            </div>

                            <div class="text-xs text-gray-600">
                                <p><strong>Interpretacja:</strong> Jeśli EV < Salary Netto, to statystycznie bardziej
                                        opłaca się brać wyższą pensję i olać udziały (lub negocjować mniejszy
                                        preference).</p>
                                        <p class="mt-2 text-gray-400 italic" id="evComment">...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const formatPLN = (num) => new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN', maximumFractionDigits: 0 }).format(num);
        const formatPercent = (num) => num.toFixed(2) + '%';
        let myChart = null;

        function syncExitVal(val) {
            document.getElementById('exitValSlider').value = val;
            document.getElementById('exitValInput').value = val;
            calculate();
        }

        // Helper to safely set text content without crashing if element is missing
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) {
                el.innerText = text;
            } else {
                console.warn(`Element with id '${id}' not found, skipping update.`);
            }
        }

        function calculateNetSalary(grossYearly, type) {
            if (grossYearly <= 0) return { netYearly: 0, taxYearly: 0 };
            const grossMonthly = grossYearly / 12;
            let netMonthly = 0;
            let totalTaxMonthly = 0;
            const ZUS_FULL = 2000;
            const KUP = 250;

            if (type === 'uop') {
                const social = grossMonthly * 0.1371;
                const baseHealth = grossMonthly - social;
                const health = baseHealth * 0.09;
                const taxBaseYearly = (grossMonthly - social - KUP) * 12;
                let annualTax = 0;
                if (taxBaseYearly <= 120000) {
                    annualTax = (taxBaseYearly * 0.12) - 3600;
                } else {
                    annualTax = (120000 * 0.12) + ((taxBaseYearly - 120000) * 0.32) - 3600;
                }
                const monthlyTax = Math.max(0, annualTax / 12);
                netMonthly = grossMonthly - social - health - monthlyTax;
                totalTaxMonthly = social + health + monthlyTax;

            } else if (type === 'b2b_lin') {
                const income = Math.max(0, grossMonthly - ZUS_FULL);
                const health = income * 0.049;
                const tax = Math.max(0, income * 0.19);
                netMonthly = grossMonthly - ZUS_FULL - health - tax;
                totalTaxMonthly = (grossMonthly - netMonthly);

            } else if (type === 'b2b_ryczalt') {
                const HEALTH_FIXED = 1100;
                const taxBase = Math.max(0, grossMonthly - ZUS_FULL);
                const tax = taxBase * 0.12;
                netMonthly = grossMonthly - ZUS_FULL - HEALTH_FIXED - tax;
                totalTaxMonthly = (grossMonthly - netMonthly);
            }

            return {
                netYearly: netMonthly * 12,
                taxYearly: totalTaxMonthly * 12
            };
        }

        function exportData(format) {
            const getVal = (id) => {
                const el = document.getElementById(id);
                if (!el) return 0;
                if (el.type === 'checkbox') return el.checked;
                return parseFloat(el.value) || 0;
            };

            const filename = `kalkulator_founder_${new Date().toISOString().split('T')[0]}`;

            // We use static values for inputs and formulas for results
            const data = [
                ["KATEGORIA", "PARAMETR", "WARTOŚĆ", "JEDNOSTKA", "OPIS"],
                ["Wejście", "Obecne udziały (Pre)", getVal('userSharesPre') / 100, "%", "Udziały przed rundą"],
                ["Wejście", "Roczna pensja (Brutto)", getVal('salary'), "PLN", "Roczny koszt pracodawcy / faktura"],
                ["Wejście", "Forma współpracy", document.getElementById('contractType').value, "", ""],
                ["Inwestycja", "Kwota inwestycji", getVal('invAmount'), "PLN", "Kapitał wpłacony przez VC"],
                ["Inwestycja", "Udziały Inwestora (Post)", getVal('invPercent') / 100, "%", "Procent spółki objęty przez VC"],
                ["Inwestycja", "Liquidation Preference", getVal('liqPref'), "x", "Mnożnik preferencji likwidacyjnej"],
                ["Inwestycja", "Participating", getVal('isParticipating'), "BOOL", "Czy inwestor uczestniczy w podziale Common Pool"],
                ["Inwestycja", "Dywidenda", getVal('dividendRate') / 100, "%", "Roczna skumulowana dywidenda"],
                ["Inwestycja", "ESOP", getVal('esopPercent') / 100, "%", "Pula esop po rundzie"],
                ["Wyjście", "Wycena Exit (Post-Money)", getVal('exitValInput'), "PLN", "Wycena przy wyjściu"],
                ["Wyjście", "Prawdopodobieństwo sukcesu", getVal('exitProb') / 100, "%", "Szansa na realizację scenariusza"],
                ["Wyjście", "Miesiące do wyjścia", getVal('monthsExit'), "msc", "Horyzont czasowy"],
                ["Wyjście", "Podatek od sprzedaży udziałów", getVal('taxRate') / 100, "%", ""],
                ["---", "---", "---", "---", "---"],
                ["WYNIKI (FORMUŁY)", "Founders Slice", { f: "1-C6-C10" }, "%", "Pozostałe udziały dla założycieli"],
                ["WYNIKI (FORMUŁY)", "Twoje udziały (Post-money)", { f: "C2*C16" }, "%", "Twój końcowy % w spółce"],
                ["WYNIKI (FORMUŁY)", "Preference Stack", { f: "C5*C7 + C5*C9*(C13/12)" }, "PLN", "Kwota należna inwestorowi przed common pool"],
                ["WYNIKI (FORMUŁY)", "Wypłata Inwestora", { f: "IF(C8, IF(C11<=C18, C11, C18 + (C11-C18)*C6), IF(C11*C6 > C18, C11*C6, MIN(C11, C18)))" }, "PLN", "Całkowita kwota dla VC"],
                ["WYNIKI (FORMUŁY)", "Common Pool", { f: "C11-C19" }, "PLN", "Kwota pozostała do podziału"],
                ["WYNIKI (FORMUŁY)", "Twój udział (Gross)", { f: "IF(C8, C20*C17, IF(C11*C6 > C18, C11*C17, C20 * (C17 / (1-C6))))" }, "PLN", "Twoja kwota przed podatkiem"],
                ["WYNIKI (FORMUŁY)", "Podatek od Equity", { f: "C21*C14" }, "PLN", ""],
                ["WYNIKI (FORMUŁY)", "Equity Netto", { f: "C21-C22" }, "PLN", "Twoja kasa na rękę ze sprzedaży"],
                ["WYNIKI (FORMUŁY)", "Pensja Netto (Suma)", parseFloat(document.getElementById('salaryNetTotalDisplay').innerText.replace(/[^0-9]/g, '')), "PLN", "Zależne od formy opodatkowania"],
                ["WYNIKI (FORMUŁY)", "TOTAL DO RĘKI", { f: "C23+C24" }, "PLN", "Suma pensji i equity (Netto)"],
                ["WYNIKI (FORMUŁY)", "TOTAL EV (Ważone)", { f: "C23*C12 + C24" }, "PLN", "Wartość oczekiwana"]
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set formats
            const fmtPercent = "0.00%";
            const fmtCurrency = "#,##0\" PLN\"";

            // Apply formatting to specific cells if it's XLSX
            if (format === 'xlsx') {
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                    const cellUnit = ws[XLSX.utils.encode_cell({ r: R, c: 3 })];
                    const cellVal = ws[XLSX.utils.encode_cell({ r: R, c: 2 })];
                    if (cellVal && cellUnit) {
                        if (cellUnit.v === '%') cellVal.z = fmtPercent;
                        if (cellUnit.v === 'PLN') cellVal.z = fmtCurrency;
                    }
                }
                // Set column widths
                ws['!cols'] = [{ wch: 20 }, { wch: 30 }, { wch: 20 }, { wch: 10 }, { wch: 40 }];
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Kalkulacja");

            if (format === 'csv') {
                XLSX.writeFile(wb, `${filename}.csv`, { bookType: 'csv', FS: ';' });
            } else {
                XLSX.writeFile(wb, `${filename}.xlsx`);
            }
        }

        function calculate() {
            // Inputs (using safe fallbacks)
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? parseFloat(el.value) : 0;
            };

            const userSharesPre = getVal('userSharesPre') / 100;
            const salaryYearly = getVal('salary');

            const contractTypeEl = document.getElementById('contractType');
            const contractType = contractTypeEl ? contractTypeEl.value : 'b2b_lin';

            const invAmount = getVal('invAmount');
            const invPercent = getVal('invPercent') / 100;
            const liqPrefMult = getVal('liqPref');
            const esopPercent = getVal('esopPercent') / 100;
            const exitVal = getVal('exitValInput');
            const months = getVal('monthsExit');
            const years = months / 12;
            const taxRate = getVal('taxRate') / 100;
            const exitProb = getVal('exitProb') / 100;

            const isParticipatingEl = document.getElementById('isParticipating');
            const isParticipating = isParticipatingEl ? isParticipatingEl.checked : false;

            const dividendRate = getVal('dividendRate') / 100;

            const descMap = {
                'uop': 'Wysoki ZUS, Progi 12%/32%. Bezpieczeństwo, ale wysoki koszt.',
                'b2b_lin': 'Stałe 19% + ZUS + 4.9% Zdrowotna. Dobre przy bardzo wysokich dochodach.',
                'b2b_ryczalt': 'Niski podatek 12% od przychodu. Brak kosztów, stała składka zdrowotna.'
            };
            safeSetText('taxDesc', descMap[contractType]);

            // 1. Structure
            const foundersSlice = 1 - invPercent - esopPercent;
            const userSharesPost = userSharesPre * foundersSlice;

            // 2. Preference
            const basePref = invAmount * liqPrefMult;
            const totalDividends = invAmount * dividendRate * years;
            const totalPrefStack = basePref + totalDividends;

            // 3. Waterfall
            let investorPayout = 0;
            let userEquityPayout = 0;
            let commonPool = 0;

            if (isParticipating) {
                if (exitVal <= totalPrefStack) {
                    investorPayout = exitVal;
                    commonPool = 0;
                } else {
                    investorPayout = totalPrefStack;
                    commonPool = exitVal - totalPrefStack;
                    investorPayout += commonPool * invPercent;
                }
            } else {
                const conversionValue = exitVal * invPercent;
                if (conversionValue > totalPrefStack) {
                    investorPayout = conversionValue;
                    commonPool = exitVal - investorPayout;
                } else {
                    if (exitVal <= totalPrefStack) {
                        investorPayout = exitVal;
                        commonPool = 0;
                    } else {
                        investorPayout = totalPrefStack;
                        commonPool = exitVal - totalPrefStack;
                    }
                }
            }

            if (commonPool > 0) {
                if (isParticipating) {
                    userEquityPayout = commonPool * userSharesPost;
                } else {
                    const conversionValue = exitVal * invPercent;
                    if (conversionValue > totalPrefStack) {
                        userEquityPayout = exitVal * userSharesPost;
                    } else {
                        const relativeShare = userSharesPost / (1 - invPercent);
                        userEquityPayout = commonPool * relativeShare;
                    }
                }
            } else {
                userEquityPayout = 0;
            }

            // 4. Taxes & Salary
            const userEquityTax = userEquityPayout * taxRate;
            const userEquityNet = userEquityPayout - userEquityTax;

            const salaryData = calculateNetSalary(salaryYearly, contractType);
            const totalSalaryNet = salaryData.netYearly * years;
            const totalSalaryTax = salaryData.taxYearly * years;

            // Totals
            const totalUserNet = userEquityNet + totalSalaryNet;

            // 5. EV Calculation
            const evEquity = userEquityNet * exitProb;
            const evTotal = evEquity + totalSalaryNet;


            // Update UI (using safeSetText)
            safeSetText('userDilutedShares', formatPercent(userSharesPost * 100));
            safeSetText('dilutionInfo', `Z ${userSharesPre * 100}% na ${formatPercent(userSharesPost * 100)}`);
            safeSetText('userNetTotal', formatPLN(totalUserNet));

            safeSetText('salaryNetTotalDisplay', formatPLN(totalSalaryNet));
            safeSetText('salaryTypeDisplay', `Przez ${months} mies. (${contractType.toUpperCase().replace('_', ' ')})`);
            safeSetText('salaryLabelDisplay', `Pensja Netto (${months} mies.)`);

            // EV UI
            safeSetText('evTotal', formatPLN(evTotal));
            safeSetText('evProbDisplay', (exitProb * 100).toFixed(0) + '%');
            safeSetText('evEquity', formatPLN(evEquity));
            safeSetText('evSalary', formatPLN(totalSalaryNet));
            safeSetText('evTotalBox', formatPLN(evTotal));

            // Warning for negative salary
            const warningEl = document.getElementById('salaryWarning');
            if (warningEl) {
                warningEl.classList.toggle('hidden', totalSalaryNet >= 0 || salaryYearly === 0);
            }

            const evCommentEl = document.getElementById('evComment');
            if (evCommentEl) {
                if (evEquity < totalSalaryNet * 0.2) {
                    evCommentEl.innerText = "Ryzyko jest zbyt duże w stosunku do nagrody. Grasz w lotto, a nie inwestujesz.";
                } else if (evEquity > totalSalaryNet) {
                    evCommentEl.innerText = "Gra warta świeczki. EV z udziałów przebija pensję.";
                } else {
                    evCommentEl.innerText = "Solidny zakład. Wartość udziałów waży tyle, co Twoja praca.";
                }
            }

            // Table 1
            safeSetText('tblExit', formatPLN(exitVal));
            safeSetText('tblPref', "-" + formatPLN(totalPrefStack));
            safeSetText('tblCommon', formatPLN(commonPool));
            safeSetText('tblUserGross', formatPLN(userEquityPayout));
            safeSetText('tblTax', "-" + formatPLN(userEquityTax));
            safeSetText('tblUserNet', formatPLN(userEquityNet));
            safeSetText('taxRateDisplay', (taxRate * 100).toFixed(0));

            const badge = document.getElementById('participatingBadge');
            if (badge) badge.classList.toggle('hidden', !isParticipating);

            // Chart
            const othersPayout = exitVal - investorPayout - userEquityPayout;
            updateChart(investorPayout, userEquityNet, userEquityTax, Math.max(0, othersPayout), totalSalaryNet);
        }

        function updateChart(investor, userEquity, equityTax, others, salaryNet) {
            const ctxEl = document.getElementById('waterfallChart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');

            const data = {
                labels: ['Inwestor', 'Equity Netto (Ty)', 'Pensja Netto (Ty)', 'Podatki (Ty)', 'Reszta (ESOP/Fnd)'],
                datasets: [{
                    label: 'Wartość (PLN)',
                    data: [investor, userEquity, salaryNet, equityTax, others],
                    backgroundColor: [
                        '#DC2626', // Inwestor
                        '#16A34A', // Equity Net
                        '#4F46E5', // Pensja Net
                        '#9CA3AF', // Podatki
                        '#BFDBFE'  // Reszta
                    ],
                    borderWidth: 1,
                    borderRadius: 4
                }]
            };

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return formatPLN(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f3f4f6'
                            },
                            ticks: {
                                callback: function (value) {
                                    if (value >= 1000000) return (value / 1000000).toFixed(1) + ' mln';
                                    if (value >= 1000) return (value / 1000).toFixed(0) + ' k';
                                    return value;
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        calculate();
    </script>
</body>

</html>