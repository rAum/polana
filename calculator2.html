<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator VC Pro - Dynamic Founders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #334155;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
            font-weight: normal;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        .bar-segment {
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            white-space: nowrap;
        }

        .bar-segment span {
            padding: 0 4px;
            opacity: 1;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body class="text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-calculator"></i></div>
                <h1 class="text-lg font-bold text-slate-800">Founder VC Simulator <span class="text-blue-600">Pro</span>
                </h1>
            </div>

            <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200 text-sm">
                <select id="mainCurrency"
                    class="bg-white border rounded px-2 py-1 font-bold text-slate-700 text-xs focus:outline-none"
                    onchange="calculate()">
                    <option value="PLN">PLN (zł)</option>
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                </select>
                <div class="h-4 w-px bg-gray-300"></div>
                <button onclick="resetData()"
                    class="text-xs text-red-500 hover:text-red-700 px-2 py-1 font-medium">Reset</button>
                <button onclick="saveData()"
                    class="text-xs bg-slate-800 text-white hover:bg-slate-700 px-4 py-2 rounded shadow transition"
                    id="saveBtn">Zapisz</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- LEWA KOLUMNA: Konfiguracja -->
        <div class="lg:col-span-4 space-y-5">

            <!-- Sekcja 1: Cap Table -->
            <div class="card p-5 border-l-4 border-emerald-500">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-slate-800 text-sm uppercase tracking-wide">1. Cap Table</h2>
                    <div class="flex flex-col items-end">
                        <select id="founderCount" class="text-xs border rounded p-1 bg-gray-50 mb-1"
                            onchange="renderFounderInputs(); validateCapTable();">
                            <option value="1">1 Founder</option>
                            <option value="2">2 Founderów</option>
                            <option value="3" selected>3 Founderów</option>
                            <option value="4">4 Founderów</option>
                        </select>
                        <span id="capTableSum" class="text-[10px] font-bold text-emerald-600">Suma: 100%</span>
                    </div>
                </div>

                <div id="founderInputsContainer" class="space-y-2 text-sm">
                    <!-- Dynamicznie generowane w JS -->
                </div>
            </div>

            <!-- Sekcja 2: Runda Inwestycyjna -->
            <div class="card p-5 border-l-4 border-blue-500">
                <h2 class="font-bold text-slate-800 text-sm uppercase tracking-wide mb-3">2. Parametry Rundy</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Inwestycja (Cash
                            In)</label>
                        <div class="relative">
                            <span class="absolute left-2 top-1.5 text-gray-400 text-xs currency-symbol">zł</span>
                            <input type="number" id="investment"
                                class="w-full pl-8 p-1.5 border rounded font-bold text-slate-800 text-sm focus:ring-1 focus:ring-blue-200"
                                value="1000000" oninput="recalcRound('investment')">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Pre-Money</label>
                            <input type="number" id="preMoney" class="w-full p-1.5 border rounded text-xs"
                                value="4000000" oninput="recalcRound('pre')">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold uppercase text-blue-600 mb-1">Udział VC
                                (%)</label>
                            <input type="number" id="investorShareInput"
                                class="w-full p-1.5 border border-blue-200 bg-blue-50 rounded font-bold text-blue-700 text-xs"
                                value="20" oninput="recalcRound('pct')">
                        </div>
                    </div>
                    <div class="text-right text-xs text-gray-500">Post-Money: <span id="postMoneyDisplay"
                            class="font-bold text-slate-800">5 000 000 zł</span></div>
                </div>
            </div>

            <!-- Sekcja 3: Vesting i Rozwodnienie -->
            <div class="card p-5 border-l-4 border-orange-500 bg-orange-50/10">
                <h2 class="font-bold text-slate-800 text-sm uppercase tracking-wide mb-3 flex items-center gap-2">
                    3. Czas i Vesting
                </h2>

                <div class="space-y-4">
                    <!-- Przyszłe Rozwodnienie -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="block text-[10px] font-bold uppercase text-gray-500">Przyszłe Rozwodnienie
                                (Dilution)</label>
                            <span id="futureDilutionVal" class="text-[10px] font-bold text-orange-600">0%</span>
                        </div>
                        <input type="range" id="futureDilution" min="0" max="80" value="0"
                            class="w-full h-1.5 bg-gray-200 rounded-lg accent-orange-500"
                            oninput="updateRangeVal('futureDilutionVal', this.value); calculate()">
                    </div>

                    <hr class="border-orange-100">

                    <!-- Timeline i Trigger -->
                    <div>
                        <div class="flex justify-between mb-1 items-end">
                            <label class="block text-[10px] font-bold uppercase text-gray-500">Moment Exitu
                                (Miesiąc)</label>
                            <span class="text-[10px] font-bold text-white bg-blue-600 px-2 py-0.5 rounded shadow"
                                id="monthDisplay">48 msc</span>
                        </div>
                        <input type="range" id="monthsToExit" min="0" max="60" value="48"
                            class="w-full h-1.5 bg-gray-200 rounded-lg accent-blue-600"
                            oninput="updateMonthDisplay(this.value); calculate()">

                        <div id="vestingExplanation"
                            class="mt-2 p-2 bg-white rounded border border-blue-100 text-[10px] text-gray-600 leading-tight">
                            Status: Pełny vesting.
                        </div>

                        <div class="flex justify-between text-[9px] text-gray-400 mt-1">
                            <span>Start (0)</span>
                            <span>Cliff (12)</span>
                            <span>Vested (48)</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <div>
                            <label class="block text-[9px] font-bold uppercase text-gray-500 mb-1">Przyspieszenie
                                (Trigger)</label>
                            <select id="accelerationType" class="w-full p-1.5 border rounded text-xs bg-white"
                                onchange="toggleTriggerOptions(); calculate()">
                                <option value="none">Brak (Standard)</option>
                                <option value="single">Single (100% Exit)</option>
                                <option value="double">Double (Change + Fire)</option>
                            </select>
                        </div>
                        <div id="doubleTriggerOption" class="hidden">
                            <label class="block text-[9px] font-bold uppercase text-red-500 mb-1">Czy zwolniony?</label>
                            <select id="isFired" class="w-full p-1.5 border border-red-200 rounded text-xs bg-red-50"
                                onchange="calculate()">
                                <option value="no">Nie</option>
                                <option value="yes">Tak (Zwolniony)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sekcja 4: Term Sheet -->
            <div class="card p-5 border-l-4 border-purple-500">
                <h2 class="font-bold text-slate-800 text-sm uppercase tracking-wide mb-3">4. Liquidation Preference</h2>
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Mnożnik (x)</label>
                        <input type="number" id="liqPrefMult" class="w-full p-1.5 border rounded text-xs" value="1.0"
                            step="0.1" oninput="calculate()">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Typ</label>
                        <select id="participationType" class="w-full p-1.5 border rounded bg-white text-xs"
                            onchange="calculate()">
                            <option value="non-participating">Non-Participating</option>
                            <option value="participating">Participating</option>
                        </select>
                    </div>
                </div>
            </div>

        </div>

        <!-- PRAWA KOLUMNA: Wyniki -->
        <div class="lg:col-span-8 flex flex-col gap-6">

            <!-- Panel Symulacji -->
            <div class="card p-6 md:p-8 flex-grow border border-gray-100">
                <div class="mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-end mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Symulacja Wyjścia (Exit)</h2>
                            <p class="text-xs text-gray-500 mt-1">Wartość całej spółki przy sprzedaży.</p>
                        </div>
                        <div class="relative">
                            <span
                                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 font-bold currency-symbol">zł</span>
                            <input type="number" id="exitManualInput" value="20000000"
                                class="w-full md:w-48 pl-8 pr-4 py-2 border-2 border-blue-100 rounded-lg text-xl font-bold text-blue-700 text-right focus:ring-2 focus:ring-blue-500 outline-none"
                                oninput="syncSlider(this.value)">
                        </div>
                    </div>
                    <input type="range" id="exitSlider" min="0" max="100000000" step="100000" value="20000000"
                        class="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600 transition-all"
                        oninput="syncInput(this.value)">
                </div>

                <!-- Waterfall Chart -->
                <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 mb-6">
                    <h3 class="text-xs font-bold text-slate-600 uppercase mb-3">Struktura Wypłaty (Kto ile bierze)</h3>
                    <div class="w-full h-10 flex rounded-lg overflow-hidden font-bold text-white text-[9px] shadow bg-gray-200 relative"
                        id="waterfallChart"></div>
                    <div id="waterfallLegend"
                        class="flex flex-wrap gap-x-4 gap-y-2 mt-3 text-[10px] text-gray-600 justify-center">
                        <!-- Legend injected via JS -->
                    </div>
                </div>

                <!-- Karty Wyników Founderów -->
                <div id="founderResultsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Injected via JS -->
                </div>

                <!-- VC Result Card -->
                <div class="border border-blue-100 bg-slate-50 rounded-lg p-4 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-[10px] text-blue-500 uppercase font-bold tracking-wider">Inwestor VC</div>
                            <div class="text-xl font-black text-slate-800" id="vcPayout">0 zł</div>
                            <div class="text-[10px] text-gray-500" id="vcStructureType">Participating</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-600" id="vcRoi">ROI: 0x</div>
                            <div class="text-[10px] text-gray-400">Cash-on-Cash</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela Scenariuszy -->
            <div class="card p-6 overflow-hidden">
                <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide mb-4">Scenariusze (Co jeśli...?)
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-2 font-semibold">Exit</th>
                                <th class="px-4 py-2 font-semibold text-blue-600">Dla VC</th>
                                <th class="px-4 py-2 font-semibold text-emerald-600">F1 Netto</th>
                                <th class="px-4 py-2 font-semibold text-red-400 text-right">F1 Utracone</th>
                            </tr>
                        </thead>
                        <tbody id="scenarioTableBody" class="divide-y divide-gray-100 bg-white text-xs"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const currencyMap = { 'PLN': { symbol: 'zł', locale: 'pl-PL' }, 'USD': { symbol: '$', locale: 'en-US' }, 'EUR': { symbol: '€', locale: 'de-DE' } };
        const founderColors = ['bg-emerald-600', 'bg-emerald-500', 'bg-emerald-400', 'bg-teal-400'];
        let currentCurrency = 'PLN';

        // --- RENDER FOUNDER INPUTS ---
        function renderFounderInputs() {
            const count = parseInt(document.getElementById('founderCount').value);
            const container = document.getElementById('founderInputsContainer');
            const savedNames = [1, 2, 3, 4].map(i => document.getElementById(`f${i}Name`)?.value || (i === 4 ? "Founder 4" : i === 3 ? "Option Pool" : `Founder ${i}`));
            const savedShares = [1, 2, 3, 4].map(i => document.getElementById(`f${i}Share`)?.value || (i === 1 ? 50 : i === 2 ? 30 : 20));

            container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <input type="text" id="f${i}Name" value="${savedNames[i - 1]}" class="w-1/3 p-1.5 bg-gray-50 border rounded text-xs" placeholder="Imię">
                    <div class="relative w-2/3">
                        <input type="number" id="f${i}Share" value="${savedShares[i - 1]}" class="w-full pl-2 pr-6 p-1.5 border rounded text-xs" oninput="validateCapTable()">
                        <span class="absolute right-2 top-1.5 text-gray-400 text-xs">%</span>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // --- UI HELPERS ---
        const formatMoney = (val) => {
            const conf = currencyMap[currentCurrency];
            return val.toLocaleString(conf.locale, { maximumFractionDigits: 0, style: 'currency', currency: currentCurrency });
        };

        const updateRangeVal = (id, val) => document.getElementById(id).innerText = val + '%';
        const updateMonthDisplay = (val) => {
            document.getElementById('monthDisplay').innerText = `${val} msc`;
            const cliff = 12, total = 48;
            let msg = val < cliff && val > 0 ? `<span class="text-red-500 font-bold">CLIFF!</span> 0% akcji.` : (val >= total ? `<span class="text-green-600 font-bold">PEŁNY VESTING!</span> 100% akcji.` : `<span class="text-blue-600 font-bold">Vesting w toku:</span> ${((val / total) * 100).toFixed(1)}% uprawnień.`);
            document.getElementById('vestingExplanation').innerHTML = msg;
        };

        function toggleTriggerOptions() {
            document.getElementById('doubleTriggerOption').classList.toggle('hidden', document.getElementById('accelerationType').value !== 'double');
        }

        function syncInput(val) { document.getElementById('exitManualInput').value = val; calculate(); }
        function syncSlider(val) { document.getElementById('exitSlider').value = val; calculate(); }

        function validateCapTable() {
            const count = parseInt(document.getElementById('founderCount').value);
            let sum = 0;
            for (let i = 1; i <= count; i++) sum += parseFloat(document.getElementById(`f${i}Share`).value) || 0;
            const sumEl = document.getElementById('capTableSum');
            sumEl.innerText = `Suma: ${sum.toFixed(1)}%`;
            sumEl.className = Math.abs(sum - 100) > 0.1 ? "text-[10px] font-bold text-red-500" : "text-[10px] font-bold text-emerald-600";
            calculate();
        }

        function recalcRound(source) {
            const investment = parseFloat(document.getElementById('investment').value) || 0;
            const preMoney = parseFloat(document.getElementById('preMoney').value) || 0;
            if (source === 'investment' || source === 'pre') {
                const post = preMoney + investment;
                document.getElementById('investorShareInput').value = post > 0 ? ((investment / post) * 100).toFixed(2) : 0;
            } else if (source === 'pct') {
                const pct = parseFloat(document.getElementById('investorShareInput').value) / 100;
                if (pct > 0 && pct < 1) document.getElementById('preMoney').value = (investment / pct - investment).toFixed(0);
            }
            calculate();
        }

        // --- CALCULATION ---
        function calculate() {
            currentCurrency = document.getElementById('mainCurrency').value;
            const sym = currencyMap[currentCurrency].symbol;
            document.querySelectorAll('.currency-symbol').forEach(el => el.innerText = sym);

            const investment = parseFloat(document.getElementById('investment').value) || 0;
            const preMoney = parseFloat(document.getElementById('preMoney').value) || 0;
            const postMoney = preMoney + investment;
            document.getElementById('postMoneyDisplay').innerText = formatMoney(postMoney);

            const count = parseInt(document.getElementById('founderCount').value);
            const founderShares = [];
            let totalFounderCap = 0;
            for (let i = 1; i <= count; i++) {
                const s = (parseFloat(document.getElementById(`f${i}Share`).value) || 0) / 100;
                founderShares.push(s);
                totalFounderCap += s;
            }

            const futureDilutionPct = parseFloat(document.getElementById('futureDilution').value) / 100;
            const exitValue = parseFloat(document.getElementById('exitManualInput').value) || 0;
            const monthsPassed = parseFloat(document.getElementById('monthsToExit').value) || 0;
            const accelerationType = document.getElementById('accelerationType').value;
            const isFired = document.getElementById('isFired').value === 'yes';

            let vestedPct = (monthsPassed >= 12) ? Math.min(1, monthsPassed / 48) : 0;
            if (accelerationType === 'single' || (accelerationType === 'double' && isFired)) vestedPct = 1.0;

            const vcSharePctInitial = postMoney > 0 ? investment / postMoney : 0;
            const effectiveVcShare = vcSharePctInitial * (1 - futureDilutionPct);
            const foundersPoolAtExit = (1 - vcSharePctInitial) * (1 - futureDilutionPct);

            const liqPrefMult = parseFloat(document.getElementById('liqPrefMult').value) || 1;
            const participationType = document.getElementById('participationType').value;
            let liqPrefAmt = Math.min(exitValue, investment * liqPrefMult);

            let vcPayout = 0;
            let remainingForCommon = 0;

            if (participationType === 'non-participating') {
                const convertPayout = exitValue * effectiveVcShare;
                if (convertPayout > liqPrefAmt) {
                    vcPayout = convertPayout;
                    liqPrefAmt = 0;
                    remainingForCommon = exitValue - vcPayout;
                    document.getElementById('vcStructureType').innerText = "Converted to Common";
                } else {
                    vcPayout = liqPrefAmt;
                    remainingForCommon = exitValue - vcPayout;
                    document.getElementById('vcStructureType').innerText = "Preference Only";
                }
            } else {
                vcPayout = liqPrefAmt;
                const partPayout = Math.max(0, (exitValue - liqPrefAmt) * effectiveVcShare);
                vcPayout += partPayout;
                remainingForCommon = Math.max(0, exitValue - vcPayout);
                document.getElementById('vcStructureType').innerText = "Participating (Double Dip)";
            }

            const dilutionEquityStake = futureDilutionPct;
            const totalCommonEquityStake = dilutionEquityStake + foundersPoolAtExit;
            let foundersPoolCash = (totalCommonEquityStake > 0) ? remainingForCommon * (foundersPoolAtExit / totalCommonEquityStake) : 0;
            let dilutionCash = (totalCommonEquityStake > 0) ? remainingForCommon * (dilutionEquityStake / totalCommonEquityStake) : 0;

            // Update Cards and Waterfall Segments
            const resultsGrid = document.getElementById('founderResultsGrid');
            const waterfallChart = document.getElementById('waterfallChart');
            const legend = document.getElementById('waterfallLegend');
            resultsGrid.innerHTML = ''; waterfallChart.innerHTML = '';
            legend.innerHTML = `<div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-purple-600 rounded"></div>Liq Pref</div><div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-blue-500 rounded"></div>VC Profit</div>`;

            let totalFounderNet = 0;
            let totalUnvestedLost = 0;

            founderShares.forEach((share, idx) => {
                const i = idx + 1;
                const name = document.getElementById(`f${i}Name`).value;
                const gross = (totalFounderCap > 0) ? foundersPoolCash * (share / totalFounderCap) : 0;
                const net = gross * vestedPct;
                const lost = gross * (1 - vestedPct);
                totalFounderNet += net;
                totalUnvestedLost += lost;

                resultsGrid.innerHTML += `
                    <div class="border border-emerald-100 bg-white rounded-lg p-3 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full ${founderColors[idx]}"></div>
                        <div class="flex justify-between items-start">
                            <div><div class="text-[10px] text-gray-500 uppercase font-bold">${name}</div><div class="text-lg font-black text-slate-800">${formatMoney(net)}</div></div>
                            <div class="text-right"><div class="text-[9px] font-bold text-emerald-700">${(vestedPct * 100).toFixed(0)}% Vested</div><div class="text-[9px] text-red-400 mt-0.5">Utracone: ${formatMoney(lost)}</div></div>
                        </div>
                    </div>`;
                legend.innerHTML += `<div class="flex items-center gap-1.5"><div class="w-3 h-3 ${founderColors[idx]} rounded"></div>${name}</div>`;
            });

            legend.innerHTML += `<div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-slate-400 rounded"></div>Dilution</div><div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-red-100 border border-red-300 rounded"></div>Utracone</div>`;

            // Draw Waterfall
            const segments = [
                { id: 'pref', val: liqPrefAmt, color: 'bg-purple-600', label: 'PREF' },
                { id: 'vc', val: vcPayout - liqPrefAmt, color: 'bg-blue-500', label: 'VC' }
            ];
            founderShares.forEach((share, idx) => {
                const gross = (totalFounderCap > 0) ? foundersPoolCash * (share / totalFounderCap) : 0;
                segments.push({ id: `f${idx + 1}`, val: gross * vestedPct, color: founderColors[idx], label: `F${idx + 1}` });
            });
            segments.push({ id: 'dil', val: dilutionCash, color: 'bg-slate-400', label: 'DIL' });
            segments.push({ id: 'lost', val: totalUnvestedLost, color: 'bg-red-100 text-red-800', label: 'LOST' });

            segments.forEach(seg => {
                if (seg.val > 0) {
                    const w = (seg.val / (exitValue || 1)) * 100;
                    if (w > 0.5) {
                        const div = document.createElement('div');
                        div.className = `bar-segment ${seg.color} h-full`;
                        div.style.width = w + '%';
                        div.innerHTML = `<span>${seg.label}</span>`;
                        div.title = `${seg.label}: ${formatMoney(seg.val)}`;
                        waterfallChart.appendChild(div);
                    }
                }
            });

            document.getElementById('vcPayout').innerText = formatMoney(vcPayout);
            document.getElementById('vcRoi').innerText = `ROI: ${investment > 0 ? (vcPayout / investment).toFixed(2) : 0}x`;

            generateScenarioTable(effectiveVcShare, liqPrefAmt, participationType, foundersPoolAtExit, totalCommonEquityStake, totalFounderCap, founderShares[0], vestedPct, investment);
        }

        function generateScenarioTable(effVc, pref, type, fPoolPct, commonStake, f1Cap, f1Share, vestPct, inv) {
            const tbody = document.getElementById('scenarioTableBody');
            tbody.innerHTML = '';
            [inv * 2, inv * 5, inv * 10, inv * 20, inv * 50].forEach(val => {
                let localVcPayout = 0;
                let localPref = Math.min(val, pref);
                if (type === 'non-participating') {
                    const conv = val * effVc;
                    localVcPayout = conv > localPref ? conv : localPref;
                } else {
                    localVcPayout = localPref + Math.max(0, (val - localPref) * effVc);
                }
                const rem = Math.max(0, val - localVcPayout);
                const fPoolCash = (commonStake > 0) ? rem * (fPoolPct / commonStake) : 0;
                const f1Gross = (f1Cap > 0) ? fPoolCash * (f1Share / f1Cap) : 0;
                tbody.innerHTML += `<tr><td class="px-4 py-2 font-medium">${formatMoney(val)}</td><td class="px-4 py-2 text-blue-600">${formatMoney(localVcPayout)}</td><td class="px-4 py-2 font-bold text-emerald-600">${formatMoney(f1Gross * vestPct)}</td><td class="px-4 py-2 text-right text-red-400 text-[10px]">${formatMoney(f1Gross * (1 - vestPct))}</td></tr>`;
            });
        }

        // --- DATA ---
        function saveData() {
            const data = {
                founderCount: document.getElementById('founderCount').value,
                investment: document.getElementById('investment').value,
                preMoney: document.getElementById('preMoney').value,
                futureDilution: document.getElementById('futureDilution').value,
                monthsToExit: document.getElementById('monthsToExit').value,
                accelerationType: document.getElementById('accelerationType').value,
                isFired: document.getElementById('isFired').value,
                liqPrefMult: document.getElementById('liqPrefMult').value,
                participationType: document.getElementById('participationType').value,
                exitManualInput: document.getElementById('exitManualInput').value,
                mainCurrency: document.getElementById('mainCurrency').value
            };
            for (let i = 1; i <= 4; i++) {
                data[`f${i}Name`] = document.getElementById(`f${i}Name`)?.value;
                data[`f${i}Share`] = document.getElementById(`f${i}Share`)?.value;
            }
            localStorage.setItem('vcDynamicData', JSON.stringify(data));
            const btn = document.getElementById('saveBtn'); btn.innerText = "Zapisano!"; setTimeout(() => btn.innerText = "Zapisz", 2000);
        }

        function loadData() {
            const s = localStorage.getItem('vcDynamicData');
            if (s) {
                const d = JSON.parse(s);
                document.getElementById('founderCount').value = d.founderCount || 3;
                renderFounderInputs();
                ['investment', 'preMoney', 'futureDilution', 'monthsToExit', 'accelerationType', 'isFired', 'liqPrefMult', 'participationType', 'exitManualInput', 'mainCurrency'].forEach(k => { if (d[k]) document.getElementById(k).value = d[k]; });
                for (let i = 1; i <= 4; i++) {
                    if (document.getElementById(`f${i}Name`)) document.getElementById(`f${i}Name`).value = d[`f${i}Name`] || (i === 4 ? "Founder 4" : `Founder ${i}`);
                    if (document.getElementById(`f${i}Share`)) document.getElementById(`f${i}Share`).value = d[`f${i}Share`] || (i === 1 ? 50 : 20);
                }
            } else { renderFounderInputs(); }
            updateMonthDisplay(document.getElementById('monthsToExit').value);
            validateCapTable();
        }

        function resetData() { if (confirm("Zresetować?")) { localStorage.removeItem('vcDynamicData'); location.reload(); } }
        window.onload = loadData;
    </script>
</body>

</html>